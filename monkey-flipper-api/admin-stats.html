<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Stats - Monkey Flipper</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 28px;
        }

        .login-form {
            background: rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
        }

        .login-form input {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            background: rgba(255,255,255,0.1);
            color: #fff;
            font-size: 16px;
            margin-bottom: 15px;
        }

        .login-form input::placeholder {
            color: rgba(255,255,255,0.5);
        }

        .login-form button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: #fff;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 25px;
            text-align: center;
        }

        .stat-card .icon {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-card .label {
            font-size: 14px;
            opacity: 0.7;
        }

        .section {
            background: rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .section h2 {
            margin-bottom: 15px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .transaction {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .transaction .user {
            display: flex;
            flex-direction: column;
        }

        .transaction .username {
            font-weight: bold;
        }

        .transaction .date {
            font-size: 12px;
            opacity: 0.6;
        }

        .transaction .amount {
            font-size: 20px;
            font-weight: bold;
            color: #4CAF50;
        }

        .loading {
            text-align: center;
            padding: 40px;
            opacity: 0.7;
        }

        .error {
            background: rgba(255,0,0,0.2);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            color: #ff6b6b;
        }

        .hidden {
            display: none;
        }

        .refresh-btn {
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 10px;
            padding: 10px 20px;
            color: #fff;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .refresh-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .ton-stats {
            margin-top: 10px;
        }

        .ton-stats .item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üêµ Monkey Flipper Admin</h1>

        <!-- –§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ -->
        <div id="loginSection" class="login-form">
            <h2 style="margin-bottom: 20px; text-align: center;">üîê –í—Ö–æ–¥ –≤ –∞–¥–º–∏–Ω–∫—É</h2>
            <input type="password" id="adminPassword" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∞">
            <button onclick="login()">–í–æ–π—Ç–∏</button>
            <p style="margin-top: 15px; font-size: 12px; opacity: 0.6; text-align: center;">
                –ü–∞—Ä–æ–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: admin123 (—Å–º–µ–Ω–∏—Ç–µ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è ADMIN_PASSWORD)
            </p>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (—Å–∫—Ä—ã—Ç–∞ –¥–æ –≤—Ö–æ–¥–∞) -->
        <div id="statsSection" class="hidden">
            <button class="refresh-btn" onclick="loadStats()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="icon">‚≠ê</div>
                    <div class="value" id="starsBalance">-</div>
                    <div class="label">Stars –±–∞–ª–∞–Ω—Å</div>
                </div>
                <div class="stat-card">
                    <div class="icon">üíé</div>
                    <div class="value" id="tonBalance">-</div>
                    <div class="label">TON –ø–æ–ª—É—á–µ–Ω–æ</div>
                </div>
                <div class="stat-card">
                    <div class="icon">üõí</div>
                    <div class="value" id="totalPurchases">-</div>
                    <div class="label">–í—Å–µ–≥–æ –ø–æ–∫—É–ø–æ–∫</div>
                </div>
                <div class="stat-card">
                    <div class="icon">üë•</div>
                    <div class="value" id="totalUsers">-</div>
                    <div class="label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                </div>
            </div>

            <div class="section">
                <h2>‚≠ê –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ Stars (–∏–∑ Telegram)</h2>
                <div id="starsTransactionsList">
                    <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>
            </div>

            <div class="section">
                <h2>üì¶ –ü–æ–∫—É–ø–∫–∏ Stars (–∏–∑ –ë–î)</h2>
                <div id="starsPurchases">
                    <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>
            </div>

            <div class="section">
                <h2>üíé –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ TON</h2>
                <div id="tonTransactions">
                    <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>
            </div>

            <div class="section">
                <h2>üõí –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–æ–∫—É–ø–∫–∏</h2>
                <div id="recentPurchases">
                    <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = window.location.hostname === 'localhost'
            ? 'http://localhost:3001'
            : 'https://monkey-flipper-djm1.onrender.com';

        let adminToken = localStorage.getItem('adminToken');

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        if (adminToken) {
            showStats();
            loadStats();
        }

        function login() {
            const password = document.getElementById('adminPassword').value;
            
            fetch(`${API_URL}/api/admin/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    adminToken = data.token;
                    localStorage.setItem('adminToken', adminToken);
                    showStats();
                    loadStats();
                } else {
                    alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!');
                }
            })
            .catch(err => {
                alert('–û—à–∏–±–∫–∞: ' + err.message);
            });
        }

        function showStats() {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('statsSection').classList.remove('hidden');
        }

        async function loadStats() {
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º Stars —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
                const starsRes = await fetch(`${API_URL}/api/admin/stars-transactions`, {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                const starsData = await starsRes.json();
                
                if (starsData.success) {
                    document.getElementById('starsBalance').textContent = starsData.totalStars + ' ‚≠ê';
                    renderStarsTransactions(starsData.transactions || []);
                }

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–∫—É–ø–∫–∏ Stars —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –≤–æ–∑–≤—Ä–∞—Ç–∞
                const starsPurchasesRes = await fetch(`${API_URL}/api/admin/stars-purchases`, {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                const starsPurchasesData = await starsPurchasesRes.json();
                
                if (starsPurchasesData.success) {
                    renderStarsPurchases(starsPurchasesData.purchases);
                }

                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ–∫—É–ø–æ–∫
                const purchasesRes = await fetch(`${API_URL}/api/admin/purchases-stats`, {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                const purchasesData = await purchasesRes.json();
                
                if (purchasesData.success) {
                    document.getElementById('totalPurchases').textContent = purchasesData.totalPurchases;
                    document.getElementById('totalUsers').textContent = purchasesData.uniqueUsers;
                    document.getElementById('tonBalance').textContent = (purchasesData.tonReceived || 0) + ' üíé';
                    renderRecentPurchases(purchasesData.recentPurchases);
                    renderTonTransactions(purchasesData.tonTransactions);
                }

            } catch (err) {
                console.error('Error loading stats:', err);
            }
        }

        function renderStarsTransactions(transactions) {
            const container = document.getElementById('starsTransactionsList');
            
            if (!transactions || transactions.length === 0) {
                container.innerHTML = '<div class="loading">–ù–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π Stars</div>';
                return;
            }

            container.innerHTML = transactions.map(tx => {
                const user = tx.source?.user || {};
                const username = user.username ? `@${user.username}` : `User ${user.id}`;
                const firstName = user.first_name || '';
                const date = new Date(tx.date * 1000).toLocaleString('ru-RU');
                const txId = tx.id || '';
                
                return `
                <div class="transaction">
                    <div class="user">
                        <span class="username">${firstName} (${username})</span>
                        <span class="date">${date}</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div class="amount" style="color: #FFD700;">${tx.amount} ‚≠ê</div>
                        <button onclick="refundTransaction(${user.id}, '${txId}')" 
                                style="padding: 5px 10px; background: #ff6b6b; border: none; border-radius: 5px; color: white; cursor: pointer; font-size: 12px;">
                            ‚Ü©Ô∏è –í–µ—Ä–Ω—É—Ç—å
                        </button>
                    </div>
                </div>
            `}).join('');
        }

        async function refundTransaction(userId, transactionId) {
            if (!confirm(`–í–µ—Ä–Ω—É—Ç—å Stars –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${userId}?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`)) {
                return;
            }
            
            try {
                const res = await fetch(`${API_URL}/api/admin/refund-by-payload`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminToken}`
                    },
                    body: JSON.stringify({ userId, transactionId })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    alert('‚úÖ ' + data.message);
                    loadStats();
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞: ' + data.error);
                }
            } catch (err) {
                alert('‚ùå –û—à–∏–±–∫–∞: ' + err.message);
            }
        }

        function renderStarsPurchases(purchases) {
            const container = document.getElementById('starsPurchases');
            
            if (!purchases || purchases.length === 0) {
                container.innerHTML = '<div class="loading">–ù–µ—Ç –ø–æ–∫—É–ø–æ–∫ –∑–∞ Stars</div>';
                return;
            }

            container.innerHTML = purchases.map(p => `
                <div class="transaction">
                    <div class="user">
                        <span class="username">${p.item_name}</span>
                        <span class="date">User ${p.user_id} ‚Ä¢ ${formatDate(p.purchased_at)} ‚Ä¢ ${p.status === 'refunded' ? 'üîÑ –í–æ–∑–≤—Ä–∞—â–µ–Ω–æ' : '‚úÖ –ê–∫—Ç–∏–≤–Ω–æ'}</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div class="amount" style="color: #FFD700;">${p.price} ‚≠ê</div>
                        ${p.can_refund ? `<button onclick="refundPurchase('${p.id}', ${p.user_id})" style="padding: 5px 10px; background: #ff6b6b; border: none; border-radius: 5px; color: white; cursor: pointer; font-size: 12px;">‚Ü©Ô∏è –í–µ—Ä–Ω—É—Ç—å</button>` : ''}
                    </div>
                </div>
            `).join('');
        }

        async function refundPurchase(purchaseId, userId) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤–µ—Ä–Ω—É—Ç—å Stars? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
                return;
            }
            
            try {
                const res = await fetch(`${API_URL}/api/admin/refund-stars`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminToken}`
                    },
                    body: JSON.stringify({ purchaseId, userId })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    alert('‚úÖ ' + data.message);
                    loadStats(); // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞: ' + data.error);
                }
            } catch (err) {
                alert('‚ùå –û—à–∏–±–∫–∞: ' + err.message);
            }
        }

        function renderTonTransactions(transactions) {
            const container = document.getElementById('tonTransactions');
            
            if (!transactions || transactions.length === 0) {
                container.innerHTML = '<div class="loading">–ù–µ—Ç TON —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</div>';
                return;
            }

            container.innerHTML = transactions.map(tx => `
                <div class="transaction">
                    <div class="user">
                        <span class="username">User ${tx.user_id}</span>
                        <span class="date">${tx.item_name} ‚Ä¢ ${formatDate(tx.purchased_at)}</span>
                    </div>
                    <div class="amount" style="color: #0088cc;">+${tx.price} üíé</div>
                </div>
            `).join('');
        }

        function renderRecentPurchases(purchases) {
            const container = document.getElementById('recentPurchases');
            
            if (!purchases || purchases.length === 0) {
                container.innerHTML = '<div class="loading">–ù–µ—Ç –ø–æ–∫—É–ø–æ–∫</div>';
                return;
            }

            container.innerHTML = purchases.map(p => `
                <div class="transaction">
                    <div class="user">
                        <span class="username">${p.item_name}</span>
                        <span class="date">User ${p.user_id} ‚Ä¢ ${formatDate(p.purchased_at)}</span>
                    </div>
                    <div class="amount" style="color: ${p.currency === 'XTR' ? '#FFD700' : p.currency === 'TON' ? '#0088cc' : '#4CAF50'};">
                        ${p.price} ${p.currency === 'XTR' ? '‚≠ê' : p.currency === 'TON' ? 'üíé' : 'ü™ô'}
                    </div>
                </div>
            `).join('');
        }

        function formatDate(timestamp) {
            const date = new Date(typeof timestamp === 'number' ? timestamp * 1000 : timestamp);
            return date.toLocaleString('ru-RU', { 
                day: '2-digit', 
                month: '2-digit', 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }
    </script>
</body>
</html>
