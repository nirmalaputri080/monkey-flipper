<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ú–∞–≥–∞–∑–∏–Ω - Monkey Flipper</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- TON Connect UI SDK - –∑–∞–≥—Ä—É–∂–∞–µ–º –≤ head -->
    <script src="https://unpkg.com/@tonconnect/ui@2.0.6/dist/tonconnect-ui.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            overflow-x: hidden;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .balance-section {
            display: flex;
            justify-content: space-around;
            margin-bottom: 30px;
            gap: 10px;
        }

        .balance-card {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            padding: 15px 25px;
            border-radius: 15px;
            text-align: center;
            flex: 1;
            border: 2px solid rgba(255,255,255,0.2);
        }

        .balance-card .label {
            font-size: 12px;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .balance-card .amount {
            font-size: 24px;
            font-weight: bold;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 10px;
        }

        .tab {
            padding: 10px 20px;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 20px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s;
        }

        .tab.active {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.5);
            transform: scale(1.05);
        }

        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 80px;
        }

        .item-card {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            border: 2px solid rgba(255,255,255,0.2);
            transition: transform 0.3s;
            cursor: pointer;
        }

        .item-card:hover {
            transform: translateY(-5px);
            border-color: rgba(255,255,255,0.5);
        }

        .item-card .icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .item-card .name {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .item-card .description {
            font-size: 11px;
            opacity: 0.8;
            margin-bottom: 10px;
            line-height: 1.3;
        }

        .item-card .price {
            font-size: 16px;
            font-weight: bold;
            padding: 8px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
        }

        .item-card .price.coins {
            color: #FFD700;
        }

        .item-card .price.stars {
            color: #00D8FF;
        }

        .back-button {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 40px;
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 25px;
            color: #fff;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .back-button:hover {
            background: rgba(255,255,255,0.3);
            transform: translateX(-50%) scale(1.05);
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
        }

        .error {
            background: rgba(255,0,0,0.2);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            border-radius: 20px;
            max-width: 400px;
            width: 100%;
            text-align: center;
            border: 2px solid rgba(255,255,255,0.3);
        }

        .modal-content .icon {
            font-size: 72px;
            margin-bottom: 15px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .modal-button:hover {
            transform: scale(1.05);
        }

        .modal-button.buy {
            background: #4CAF50;
            color: white;
        }

        .modal-button.cancel {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .payment-methods {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }

        .payment-button {
            padding: 15px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 12px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .payment-button:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
            border-color: rgba(255,255,255,0.5);
        }

        .payment-button:active {
            transform: translateY(0);
        }

        .payment-button .icon {
            font-size: 24px;
            margin-right: 10px;
        }

        .payment-button .price {
            font-size: 18px;
            font-weight: bold;
        }

        #singlePaymentSection {
            display: none;
        }

        #multiPaymentSection {
            display: none;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üõçÔ∏è –ú–∞–≥–∞–∑–∏–Ω</h1>
        <button onclick="goToGame()" style="margin-top: 10px; padding: 10px 20px; background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.3); border-radius: 10px; color: white; font-size: 16px; cursor: pointer;">
            üéÆ –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –∏–≥—Ä—É
        </button>
    </div>

    <div class="balance-section">
        <div class="balance-card" style="flex: 2;">
            <div class="label">ü™ô Monkey Coins</div>
            <div class="amount" id="coinsBalance">...</div>
        </div>
    </div>
    
    <div style="text-align: center; margin-bottom: 20px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 10px; font-size: 13px;">
        üí° –û–ø–ª–∞—Ç–∞ ‚≠ê Telegram Stars –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ Telegram
    </div>

    <div class="tabs">
        <div class="tab active" data-category="all">–í—Å—ë</div>
        <div class="tab" data-category="skins">–°–∫–∏–Ω—ã</div>
        <div class="tab" data-category="nfts">NFT</div>
        <div class="tab" data-category="boosts">–ë—É—Å—Ç—ã</div>
    </div>

    <div id="shopContent" class="items-grid">
        <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –º–∞–≥–∞–∑–∏–Ω–∞...</div>
    </div>

    <button class="back-button" onclick="goBack()">‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –≤ –∏–≥—Ä—É</button>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–æ–∫—É–ø–∫–∏ -->
    <div id="buyModal" class="modal">
        <div class="modal-content">
            <div class="icon" id="modalIcon">üé®</div>
            <h2 id="modalTitle">–ö—É–ø–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç?</h2>
            <p id="modalDescription"></p>
            
            <!-- –û–¥–∏–Ω —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã -->
            <div id="singlePaymentSection">
                <p id="modalPrice"></p>
                <div class="modal-buttons">
                    <button class="modal-button cancel" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
                    <button class="modal-button buy" onclick="confirmBuy()">–ö—É–ø–∏—Ç—å</button>
                </div>
            </div>
            
            <!-- –ù–µ—Å–∫–æ–ª—å–∫–æ —Å–ø–æ—Å–æ–±–æ–≤ –æ–ø–ª–∞—Ç—ã -->
            <div id="multiPaymentSection">
                <p style="margin-bottom: 15px; font-size: 14px;">–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã:</p>
                <div class="payment-methods">
                    <button class="payment-button" id="payCoins" onclick="selectPayment('coins')" style="display: none;">
                        <span><span class="icon">ü™ô</span> Monkey Coins</span>
                        <span class="price" id="priceCoins">0</span>
                    </button>
                    <button class="payment-button" id="payXTR" onclick="selectPayment('xtr')" style="display: none;">
                        <span><span class="icon">‚≠ê</span> Telegram Stars</span>
                        <span class="price" id="priceXTR">0</span>
                    </button>
                    <button class="payment-button" id="payTON" onclick="selectPayment('ton')" style="display: none;">
                        <span><span class="icon">üíé</span> TON</span>
                        <span class="price" id="priceTON">0</span>
                    </button>
                </div>
                <button class="modal-button cancel" onclick="closeModal()" style="margin-top: 15px; width: 100%;">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è API
        const API_URL = window.location.hostname === 'localhost'
            ? 'http://localhost:3001'
            : 'https://monkey-flipper-djm1.onrender.com';

        // Telegram WebApp
        const tg = window.Telegram?.WebApp;
        if (tg) {
            tg.ready();
            tg.expand();
        }

        // –°–æ—Å—Ç–æ—è–Ω–∏–µ
        let userId = null;
        let jwt = null;
        let shopItems = [];
        let purchasedItems = []; // –°–ø–∏—Å–æ–∫ –∫—É–ø–ª–µ–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤
        let purchasedData = {}; // –î–∞–Ω–Ω—ã–µ –æ –ø–æ–∫—É–ø–∫–∞—Ö —Å –≤—Ä–µ–º–µ–Ω–µ–º –∏—Å—Ç–µ—á–µ–Ω–∏—è
        let selectedItem = null;
        let currentCategory = 'all';

        // –ü–µ—Ä–µ—Ö–æ–¥ –≤ –∏–≥—Ä—É
        function goToGame() {
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É (–≥–¥–µ –∏–≥—Ä–∞)
            window.location.href = '/index.html';
        }
        
        // –ê–ª–∏–∞—Å –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
        const goBack = goToGame;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        async function init() {
            try {
                // –ü–æ–ª—É—á–∞–µ–º userId –∏–∑ Telegram (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: WebApp > URL –ø–∞—Ä–∞–º–µ—Ç—Ä)
                if (tg?.initDataUnsafe?.user?.id) {
                    userId = tg.initDataUnsafe.user.id;
                    console.log('‚úÖ userId –∏–∑ Telegram WebApp:', userId);
                } else {
                    // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –∏–∑ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ (–ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –∏–∑ –∏–≥—Ä—ã)
                    const urlParams = new URLSearchParams(window.location.search);
                    const urlUserId = urlParams.get('userId');
                    
                    if (urlUserId && urlUserId !== 'unknown' && !urlUserId.includes('anonymous')) {
                        userId = parseInt(urlUserId);
                        console.log('‚ö†Ô∏è userId –∏–∑ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–∞:', userId);
                    } else {
                        // –ü–æ—Å–ª–µ–¥–Ω–∏–π –≤–∞—Ä–∏–∞–Ω—Ç - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
                        throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –û—Ç–∫—Ä–æ–π—Ç–µ –º–∞–≥–∞–∑–∏–Ω –∏–∑ Telegram –±–æ—Ç–∞.');
                    }
                }

                // –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
                await authenticate();

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                await Promise.all([
                    loadBalance(),
                    loadShopItems(),
                    loadPurchases()
                ]);

                setupTabs();
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ' + error.message);
            }
        }

        // –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
        async function authenticate() {
            try {
                // –î–ª—è –º–∞–≥–∞–∑–∏–Ω–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º —É–ø—Ä–æ—â–µ–Ω–Ω—É—é –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø—Ä–æ—Å—Ç–æ–π JWT —Ç–æ–∫–µ–Ω –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ API
                const initData = tg?.initData || '';
                
                // –ï—Å–ª–∏ –µ—Å—Ç—å Telegram –¥–∞–Ω–Ω—ã–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏—Ö –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–æ–∫–µ–Ω–∞
                if (initData && userId) {
                    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø—Ä–æ—Å—Ç–æ–π —Ç–æ–∫–µ–Ω –Ω–∞ –æ—Å–Ω–æ–≤–µ userId
                    jwt = btoa(`user_${userId}_${Date.now()}`);
                    console.log('‚úÖ –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram —É—Å–ø–µ—à–Ω–∞');
                } else {
                    // –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º –±–µ–∑ Telegram
                    jwt = btoa(`test_${userId}_${Date.now()}`);
                    console.log('‚ö†Ô∏è –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏');
                }
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:', error);
                // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ä–∞–±–æ—Ç—É –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
                jwt = btoa(`fallback_${userId}_${Date.now()}`);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–ª–∞–Ω—Å–∞
        async function loadBalance() {
            try {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π endpoint /api/wallet/balance/:userId
                const response = await fetch(`${API_URL}/api/wallet/balance/${userId}`, {
                    headers: { 'Authorization': `Bearer ${jwt}` }
                });

                const data = await response.json();
                if (data.success && data.wallet) {
                    document.getElementById('coinsBalance').textContent = (data.wallet.monkeyCoin || 0).toLocaleString();
                    // Telegram Stars –±–∞–ª–∞–Ω—Å —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ Telegram, –Ω–µ –≤ –Ω–∞—à–µ–π –ë–î
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–ª–∞–Ω—Å–∞:', error);
                document.getElementById('coinsBalance').textContent = '0';
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤
        async function loadShopItems() {
            try {
                const response = await fetch(`${API_URL}/api/shop/items`, {
                    headers: { 'Authorization': `Bearer ${jwt}` }
                });

                const data = await response.json();
                if (data.success && data.items) {
                    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –æ–±—ä–µ–∫—Ç —Å –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ –≤ –ø–ª–æ—Å–∫–∏–π –º–∞—Å—Å–∏–≤
                    shopItems = [];
                    if (data.items.skins) shopItems = shopItems.concat(data.items.skins);
                    if (data.items.nft_characters) shopItems = shopItems.concat(data.items.nft_characters);
                    if (data.items.boosts) shopItems = shopItems.concat(data.items.boosts);
                    if (data.items.monkey_coin_items) shopItems = shopItems.concat(data.items.monkey_coin_items);
                    
                    console.log('‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤:', shopItems.length);
                    renderItems();
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞:', error);
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞–≥–∞–∑–∏–Ω–∞: ' + error.message);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∫—É–ø–ª–µ–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤
        async function loadPurchases() {
            try {
                const response = await fetch(`${API_URL}/api/shop/purchases/${userId}`, {
                    headers: { 'Authorization': `Bearer ${jwt}` }
                });

                const data = await response.json();
                if (data.success && data.purchases) {
                    purchasedItems = data.purchases.map(p => p.item_id);
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –æ –≤—Ä–µ–º–µ–Ω–∏ –∏—Å—Ç–µ—á–µ–Ω–∏—è
                    purchasedData = {};
                    data.purchases.forEach(p => {
                        console.log('üì¶ Purchase data:', p.item_id, p);
                        purchasedData[p.item_id] = {
                            expires_at: p.expires_at,
                            purchased_at: p.purchased_at
                        };
                    });
                    console.log('‚úÖ –ö—É–ø–ª–µ–Ω–æ –ø—Ä–µ–¥–º–µ—Ç–æ–≤:', purchasedItems.length);
                    console.log('üì¶ purchasedData:', purchasedData);
                    renderItems(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–∫—É–ø–æ–∫
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–∫—É–ø–æ–∫:', error);
            }
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤
        function renderItems() {
            const container = document.getElementById('shopContent');
            const filtered = currentCategory === 'all' 
                ? shopItems 
                : shopItems.filter(item => item.category === currentCategory);

            if (filtered.length === 0) {
                container.innerHTML = '<div class="loading">–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                return;
            }

            container.innerHTML = filtered.map(item => {
                const isPurchased = purchasedItems.includes(item.id);
                let priceHtml = '';
                
                if (isPurchased) {
                    // –ï—Å–ª–∏ –∫—É–ø–ª–µ–Ω–æ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –∏ –≤—Ä–µ–º—è –∏—Å—Ç–µ—á–µ–Ω–∏—è
                    const purchaseInfo = purchasedData[item.id];
                    let timeLeft = '24—á';
                    
                    if (purchaseInfo) {
                        // –í—ã—á–∏—Å–ª—è–µ–º –≤—Ä–µ–º—è –∏—Å—Ç–µ—á–µ–Ω–∏—è
                        let expiresAt;
                        if (purchaseInfo.expires_at) {
                            expiresAt = new Date(purchaseInfo.expires_at);
                        } else if (purchaseInfo.purchased_at) {
                            // Fallback: purchased_at + 24 —á–∞—Å–∞
                            expiresAt = new Date(purchaseInfo.purchased_at);
                            expiresAt.setHours(expiresAt.getHours() + 24);
                        }
                        
                        if (expiresAt) {
                            const now = new Date();
                            const diffMs = expiresAt - now;
                            if (diffMs > 0) {
                                const hoursLeft = Math.floor(diffMs / (1000 * 60 * 60));
                                const minsLeft = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                                timeLeft = hoursLeft > 0 ? `${hoursLeft}—á ${minsLeft}–º` : `${minsLeft}–º`;
                            } else {
                                timeLeft = '–∏—Å—Ç–µ–∫–ª–æ';
                            }
                        }
                    }
                    
                    priceHtml = `<div class="price" style="background: #4CAF50; color: white; font-weight: bold;">‚úÖ –ö–£–ü–õ–ï–ù–û</div>
                                 <div style="font-size: 11px; color: #888; margin-top: 4px;">‚è± –û—Å—Ç–∞–ª–æ—Å—å: ${timeLeft}</div>`;
                } else {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ–ø–ª–∞—Ç—ã: Coins, Telegram Stars, TON
                    if (item.currency === 'both' || item.priceXTR || item.priceTON) {
                        priceHtml = `
                            <div class="price coins" style="margin-bottom: 4px; font-size: 12px;">
                                ü™ô ${item.priceCoins || 0}
                            </div>
                            <div class="price" style="background: linear-gradient(135deg, #667eea, #764ba2); color: #fff; margin-bottom: 4px; font-size: 12px;">
                                ‚≠ê ${item.priceXTR || 0}
                            </div>
                            ${item.priceTON ? `<div class="price" style="background: linear-gradient(135deg, #0088cc, #00d4aa); color: #fff; font-size: 12px;">
                                üíé ${item.priceTON} TON
                            </div>` : ''}
                        `;
                    } else if (item.currency === 'coins') {
                        priceHtml = `<div class="price coins">ü™ô ${item.priceCoins}</div>`;
                    } else if (item.currency === 'xtr') {
                        priceHtml = `<div class="price" style="background: linear-gradient(135deg, #667eea, #764ba2); color: #fff">‚≠ê ${item.priceXTR} Stars</div>`;
                    }
                }
                
                return `
                    <div class="item-card" ${isPurchased ? '' : `onclick="showBuyModal('${item.id}')"`} style="${isPurchased ? 'opacity: 0.7; cursor: default;' : 'cursor: pointer;'}">
                        <div class="icon">${getItemIcon(item.category)}</div>
                        <div class="name">${item.name}</div>
                        <div class="description">${item.description}</div>
                        ${priceHtml}
                    </div>
                `;
            }).join('');
        }

        // –ò–∫–æ–Ω–∫–∏ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        function getItemIcon(category) {
            const icons = {
                skins: 'üé®',
                nfts: 'üñºÔ∏è',
                boosts: '‚ö°',
                cosmetic: '‚ú®'
            };
            return icons[category] || 'üéÅ';
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–∫—É–ø–∫–∏
        function showBuyModal(itemId) {
            selectedItem = shopItems.find(item => item.id === itemId);
            if (!selectedItem) return;

            document.getElementById('modalIcon').textContent = getItemIcon(selectedItem.category);
            document.getElementById('modalTitle').textContent = selectedItem.name;
            document.getElementById('modalDescription').textContent = selectedItem.description;
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä –º–µ—Ç–æ–¥–∞ –æ–ø–ª–∞—Ç—ã
            selectedPaymentMethod = null;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∫–æ–ª—å–∫–æ —Å–ø–æ—Å–æ–±–æ–≤ –æ–ø–ª–∞—Ç—ã –¥–æ—Å—Ç—É–ø–Ω–æ
            if (selectedItem.currency === 'both') {
                // –ù–µ—Å–∫–æ–ª—å–∫–æ —Å–ø–æ—Å–æ–±–æ–≤ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞
                document.getElementById('singlePaymentSection').style.display = 'none';
                document.getElementById('multiPaymentSection').style.display = 'block';
                
                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –æ–ø–ª–∞—Ç—ã: Coins, Telegram Stars, TON
                if (selectedItem.priceCoins) {
                    document.getElementById('payCoins').style.display = 'flex';
                    document.getElementById('priceCoins').textContent = `${selectedItem.priceCoins} ü™ô`;
                }
                if (selectedItem.priceXTR) {
                    document.getElementById('payXTR').style.display = 'flex';
                    document.getElementById('priceXTR').textContent = `${selectedItem.priceXTR} ‚≠ê`;
                }
                if (selectedItem.priceTON) {
                    document.getElementById('payTON').style.display = 'flex';
                    document.getElementById('priceTON').textContent = `${selectedItem.priceTON} üíé`;
                }
            } else {
                // –û–¥–∏–Ω —Å–ø–æ—Å–æ–± - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—ã—á–Ω—É—é –∫–Ω–æ–ø–∫—É –ø–æ–∫—É–ø–∫–∏
                document.getElementById('singlePaymentSection').style.display = 'block';
                document.getElementById('multiPaymentSection').style.display = 'none';
                
                let priceText = '';
                if (selectedItem.currency === 'coins') {
                    priceText = `ü™ô <strong>${selectedItem.priceCoins} Monkey Coins</strong>`;
                    selectedPaymentMethod = 'coins';
                } else if (selectedItem.currency === 'xtr') {
                    priceText = `‚≠ê <strong>${selectedItem.priceXTR} Telegram Stars</strong>`;
                    selectedPaymentMethod = 'xtr';
                } else if (selectedItem.currency === 'ton') {
                    priceText = `üíé <strong>${selectedItem.priceTON} TON</strong>`;
                    selectedPaymentMethod = 'ton';
                } else {
                    selectedPaymentMethod = 'stars';
                }
                
                document.getElementById('modalPrice').innerHTML = priceText;
            }

            document.getElementById('buyModal').classList.add('active');

            // –í–∏–±—Ä–∞—Ü–∏—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª–∫–∏
            if (tg?.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('light');
            }
        }

        // –í—ã–±–æ—Ä —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã
        function selectPayment(method) {
            selectedPaymentMethod = method;
            console.log('üí≥ –í—ã–±—Ä–∞–Ω —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã:', method);
            confirmBuy();
        }

        // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        function closeModal() {
            const modal = document.getElementById('buyModal');
            modal.classList.remove('active');
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏—Å—Ö–æ–¥–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –º–æ–¥–∞–ª–∫–∏
            const modalContent = modal.querySelector('.modal-content');
            modalContent.innerHTML = `
                <div class="icon" id="modalIcon">üé®</div>
                <h2 id="modalTitle">–ö—É–ø–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç?</h2>
                <p id="modalDescription"></p>
                
                <!-- –û–¥–∏–Ω —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã -->
                <div id="singlePaymentSection">
                    <p id="modalPrice"></p>
                    <div class="modal-buttons">
                        <button class="modal-button cancel" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
                        <button class="modal-button buy" onclick="confirmBuy()">–ö—É–ø–∏—Ç—å</button>
                    </div>
                </div>
                
                <!-- –ù–µ—Å–∫–æ–ª—å–∫–æ —Å–ø–æ—Å–æ–±–æ–≤ –æ–ø–ª–∞—Ç—ã -->
                <div id="multiPaymentSection">
                    <p style="margin-bottom: 15px; font-size: 14px;">–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã:</p>
                    <div class="payment-methods">
                        <button class="payment-button" id="payCoins" onclick="selectPayment('coins')" style="display: none;">
                            <span><span class="icon">ü™ô</span> Monkey Coins</span>
                            <span class="price" id="priceCoins">0</span>
                        </button>
                        <button class="payment-button" id="payXTR" onclick="selectPayment('xtr')" style="display: none;">
                            <span><span class="icon">‚≠ê</span> Telegram Stars</span>
                            <span class="price" id="priceXTR">0</span>
                        </button>
                        <button class="payment-button" id="payTON" onclick="selectPayment('ton')" style="display: none;">
                            <span><span class="icon">üíé</span> TON</span>
                            <span class="price" id="priceTON">0</span>
                        </button>
                    </div>
                    <button class="modal-button cancel" onclick="closeModal()" style="margin-top: 15px; width: 100%;">–û—Ç–º–µ–Ω–∞</button>
                </div>
            `;
            
            selectedItem = null;
            selectedPaymentMethod = null;
        }
        
        let selectedPaymentMethod = null;
        let tonConnectUI = null; // TON Connect UI instance

        // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ–∫—É–ø–∫–∏
        async function confirmBuy() {
            if (!selectedItem) return;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –º–µ—Ç–æ–¥ –æ–ø–ª–∞—Ç—ã –≤—ã–±—Ä–∞–Ω
            if (!selectedPaymentMethod) {
                console.error('‚ùå –ú–µ—Ç–æ–¥ –æ–ø–ª–∞—Ç—ã –Ω–µ –≤—ã–±—Ä–∞–Ω');
                return;
            }
            
            console.log('üõí –ü–æ–∫—É–ø–∫–∞:', selectedItem.name, '–∑–∞', selectedPaymentMethod);

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            const modalContent = document.querySelector('.modal-content');
            const originalHTML = modalContent.innerHTML;
            modalContent.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 48px; margin-bottom: 20px;">‚è≥</div>
                    <h2>–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–∞...</h2>
                    <p style="opacity: 0.8;">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ</p>
                </div>
            `;

            try {
                let endpoint, body;
                
                if (selectedPaymentMethod === 'xtr' || selectedItem.currency === 'xtr') {
                    // –ü–æ–∫—É–ø–∫–∞ –∑–∞ Telegram Stars (XTR) - —Å–æ–∑–¥–∞–µ–º –∏–Ω–≤–æ–π—Å
                    endpoint = '/api/shop/create-stars-invoice';
                    body = {
                        userId: userId,
                        itemId: selectedItem.id
                    };
                } else if (selectedPaymentMethod === 'ton') {
                    // –ü–æ–∫—É–ø–∫–∞ –∑–∞ TON - —Å–æ–∑–¥–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
                    endpoint = '/api/shop/create-ton-transaction';
                    body = {
                        userId: userId,
                        itemId: selectedItem.id
                    };
                } else {
                    // –ü–æ–∫—É–ø–∫–∞ –∑–∞ Monkey Coins
                    endpoint = '/api/shop/purchase';
                    body = {
                        userId: userId,
                        itemId: selectedItem.id,
                        itemName: selectedItem.name,
                        price: selectedItem.priceCoins,
                        category: selectedItem.category
                    };
                }

                const response = await fetch(`${API_URL}${endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${jwt}`
                    },
                    body: JSON.stringify(body)
                });

                const data = await response.json();
                console.log('üõí Shop response:', data);
                
                if (data.success) {
                    if (data.transaction) {
                        // TON —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è - –æ—Ç–∫—Ä—ã–≤–∞–µ–º TON Connect –¥–ª—è –æ–ø–ª–∞—Ç—ã
                        await handleTonPayment(data.transaction, data.transactionId, data.item, modalContent);
                        return;
                    } else if (data.invoice) {
                        // Telegram Stars (XTR) - –æ—Ç–∫—Ä—ã–≤–∞–µ–º –∏–Ω–≤–æ–π—Å —á–µ—Ä–µ–∑ WebApp API
                        if (tg?.HapticFeedback) {
                            tg.HapticFeedback.impactOccurred('medium');
                        }
                        
                        console.log('üìã Invoice URL received:', data.invoice);
                        
                        // –ò–∑–≤–ª–µ–∫–∞–µ–º slug –∏–∑ URL –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                        // URL —Ñ–æ—Ä–º–∞—Ç: https://t.me/$SLUG –∏–ª–∏ https://t.me/invoice/SLUG
                        let invoiceUrl = data.invoice;
                        
                        modalContent.innerHTML = `
                            <div style="text-align: center; padding: 30px;">
                                <div style="font-size: 64px; margin-bottom: 20px;">‚è≥</div>
                                <h2>–û—Ç–∫—Ä—ã–≤–∞–µ–º –æ–ø–ª–∞—Ç—É...</h2>
                                <p style="margin: 15px 0;">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –æ–ø–ª–∞—Ç—É ${selectedItem.priceXTR} ‚≠ê</p>
                            </div>
                        `;
                        
                        // –û—Ç–∫—Ä—ã–≤–∞–µ–º –∏–Ω–≤–æ–π—Å —á–µ—Ä–µ–∑ Telegram WebApp API
                        if (tg?.openInvoice) {
                            console.log('üìã Calling tg.openInvoice with:', invoiceUrl);
                            try {
                                tg.openInvoice(invoiceUrl, async (status) => {
                                    console.log('Invoice status:', status);
                                    
                                    if (status === 'paid') {
                                        // –£—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞!
                                        if (tg?.HapticFeedback) {
                                            tg.HapticFeedback.notificationOccurred('success');
                                        }
                                        
                                        modalContent.innerHTML = `
                                            <div style="text-align: center; padding: 30px;">
                                                <div style="font-size: 64px; margin-bottom: 20px;">üéâ</div>
                                                <h2>–ü–æ–∫—É–ø–∫–∞ —É—Å–ø–µ—à–Ω–∞!</h2>
                                                <p style="margin: 15px 0;">${selectedItem.name}</p>
                                                <p style="opacity: 0.8;">–û–ø–ª–∞—á–µ–Ω–æ: ${selectedItem.priceXTR} ‚≠ê</p>
                                                <button class="modal-button buy" onclick="closeModal(); loadPurchases(); loadBalance();" style="margin-top: 20px; width: 100%;">–û—Ç–ª–∏—á–Ω–æ!</button>
                                            </div>
                                        `;
                                    } else if (status === 'cancelled') {
                                        // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–º–µ–Ω–∏–ª –∏–ª–∏ –æ—à–∏–±–∫–∞ URL
                                        modalContent.innerHTML = `
                                            <div style="text-align: center; padding: 30px;">
                                                <div style="font-size: 64px; margin-bottom: 20px;">‚ùå</div>
                                                <h2>–û–ø–ª–∞—Ç–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞</h2>
                                                <p style="margin: 15px 0; opacity: 0.8;">–í—ã –æ—Ç–º–µ–Ω–∏–ª–∏ –æ–ø–ª–∞—Ç—É –∏–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞</p>
                                                <button class="modal-button cancel" onclick="closeModal()" style="margin-top: 20px; width: 100%;">–ó–∞–∫—Ä—ã—Ç—å</button>
                                            </div>
                                        `;
                                    } else if (status === 'failed') {
                                        modalContent.innerHTML = `
                                            <div style="text-align: center; padding: 30px;">
                                                <div style="font-size: 64px; margin-bottom: 20px;">‚ö†Ô∏è</div>
                                                <h2>–û—à–∏–±–∫–∞ –æ–ø–ª–∞—Ç—ã</h2>
                                                <p style="margin: 15px 0;">–°—Ç–∞—Ç—É—Å: ${status}</p>
                                                <button class="modal-button cancel" onclick="closeModal()" style="margin-top: 20px; width: 100%;">–ó–∞–∫—Ä—ã—Ç—å</button>
                                            </div>
                                        `;
                                    } else {
                                        // pending –∏–ª–∏ –¥—Ä—É–≥–æ–π —Å—Ç–∞—Ç—É—Å
                                        modalContent.innerHTML = `
                                            <div style="text-align: center; padding: 30px;">
                                                <div style="font-size: 64px; margin-bottom: 20px;">‚è≥</div>
                                                <h2>–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è...</h2>
                                                <p style="margin: 15px 0;">–°—Ç–∞—Ç—É—Å: ${status}</p>
                                                <button class="modal-button cancel" onclick="closeModal()" style="margin-top: 20px; width: 100%;">–ó–∞–∫—Ä—ã—Ç—å</button>
                                            </div>
                                        `;
                                    }
                                });
                            } catch (invoiceError) {
                                console.error('‚ùå openInvoice error:', invoiceError);
                                modalContent.innerHTML = `
                                    <div style="text-align: center; padding: 30px;">
                                        <div style="font-size: 64px; margin-bottom: 20px;">‚ùå</div>
                                        <h2>–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –æ–ø–ª–∞—Ç—ã</h2>
                                        <p style="margin: 15px 0; color: #ff6b6b;">${invoiceError.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}</p>
                                        <p style="font-size: 12px; word-break: break-all; opacity: 0.6;">URL: ${invoiceUrl}</p>
                                        <button class="modal-button cancel" onclick="closeModal()" style="margin-top: 20px; width: 100%;">–ó–∞–∫—Ä—ã—Ç—å</button>
                                    </div>
                                `;
                            }
                        } else {
                            // Fallback –µ—Å–ª–∏ openInvoice –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
                            window.open(data.invoice, '_blank');
                            closeModal();
                        }
                        return;
                    } else {
                        // –û–±—ã—á–Ω–∞—è –ø–æ–∫—É–ø–∫–∞ –∑–∞ Coins/STARS - –£–°–ü–ï–•!
                        if (tg?.HapticFeedback) {
                            tg.HapticFeedback.notificationOccurred('success');
                        }
                        
                        const balanceText = data.newBalance ? `–ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: ${data.newBalance.toLocaleString()} ü™ô` : '';
                        
                        modalContent.innerHTML = `
                            <div style="text-align: center; padding: 30px;">
                                <div style="font-size: 64px; margin-bottom: 20px;">üéâ</div>
                                <h2>–ü–æ–∫—É–ø–∫–∞ —É—Å–ø–µ—à–Ω–∞!</h2>
                                <p style="margin: 15px 0; font-size: 18px; font-weight: bold;">${selectedItem.name}</p>
                                <p style="opacity: 0.8;">‚úÖ –ü—Ä–µ–¥–º–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ –≤–∞—à –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å</p>
                                ${balanceText ? `<p style="margin-top: 10px; font-size: 14px;">${balanceText}</p>` : ''}
                                <button class="modal-button buy" onclick="closeModal()" style="margin-top: 20px; width: 100%;">–û—Ç–ª–∏—á–Ω–æ!</button>
                            </div>
                        `;
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –∏ –ø–æ–∫—É–ø–∫–∏
                        await Promise.all([
                            loadBalance(),
                            loadPurchases()
                        ]);
                    }
                } else {
                    throw new Error(data.error || '–û—à–∏–±–∫–∞ –ø–æ–∫—É–ø–∫–∏');
                }
            } catch (error) {
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
                modalContent.innerHTML = originalHTML;
                
                if (tg?.HapticFeedback) {
                    tg.HapticFeedback.notificationOccurred('error');
                }
                
                modalContent.innerHTML = `
                    <div style="text-align: center; padding: 30px;">
                        <div style="font-size: 64px; margin-bottom: 20px;">‚ùå</div>
                        <h2>–û—à–∏–±–∫–∞ –ø–æ–∫—É–ø–∫–∏</h2>
                        <p style="margin: 15px 0; color: #ff6b6b;">${error.message}</p>
                        <button class="modal-button cancel" onclick="closeModal()" style="margin-top: 20px; width: 100%;">–ó–∞–∫—Ä—ã—Ç—å</button>
                    </div>
                `;
            }
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–∞–±–æ–≤
        function setupTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentCategory = tab.dataset.category;
                    renderItems();

                    if (tg?.HapticFeedback) {
                        tg.HapticFeedback.impactOccurred('light');
                    }
                });
            });
        }

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏
        let pendingTonTransaction = null;
        let pendingTransactionId = null;
        let pendingItem = null;

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ TON –ø–ª–∞—Ç–µ–∂–∞
        async function handleTonPayment(transaction, transactionId, item, modalContent) {
            try {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏
                pendingTonTransaction = transaction;
                pendingTransactionId = transactionId;
                pendingItem = item;
                
                // –ü–æ–ª—É—á–∞–µ–º –∫–ª–∞—Å—Å TonConnectUI
                const TonConnectUIClass = window.TON_CONNECT_UI?.TonConnectUI || window.TonConnectUI;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ TON Connect UI
                if (!TonConnectUIClass) {
                    // TON Connect –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –¥–ª—è —Ä—É—á–Ω–æ–π –æ–ø–ª–∞—Ç—ã
                    showManualTonPayment(transaction, transactionId, item, modalContent);
                    return;
                }

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º TON Connect –µ—Å–ª–∏ –µ—â—ë –Ω–µ —Å–¥–µ–ª–∞–Ω–æ
                if (!tonConnectUI) {
                    tonConnectUI = new TonConnectUIClass({
                        manifestUrl: 'https://monkey-flipper-djm1.onrender.com/tonconnect-manifest.json',
                        buttonRootId: null
                    });
                    
                    // –ñ–¥—ë–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏
                    await new Promise(resolve => setTimeout(resolve, 500));
                }

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á—ë–Ω –ª–∏ –∫–æ—à–µ–ª—ë–∫
                if (!tonConnectUI.wallet) {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
                    modalContent.innerHTML = `
                        <div style="text-align: center; padding: 30px;">
                            <div style="font-size: 64px; margin-bottom: 20px;">üíé</div>
                            <h2>–û–ø–ª–∞—Ç–∞ ${item.price} TON</h2>
                            <p style="margin: 15px 0;">–ü–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª—ë–∫ –¥–ª—è –æ–ø–ª–∞—Ç—ã</p>
                            <button class="modal-button buy" onclick="connectAndPayTon()" style="margin-top: 15px; width: 100%;">üîó –ü–æ–¥–∫–ª—é—á–∏—Ç—å –∏ –æ–ø–ª–∞—Ç–∏—Ç—å</button>
                            <button class="modal-button cancel" onclick="showManualPaymentOption()" style="margin-top: 10px; width: 100%;">–û–ø–ª–∞—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é</button>
                        </div>
                    `;
                    return;
                }

                // –ö–æ—à–µ–ª—ë–∫ –ø–æ–¥–∫–ª—é—á—ë–Ω - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
                await sendTonTransaction(transaction, transactionId, item, modalContent);

            } catch (error) {
                console.error('TON payment error:', error);
                handleTonError(error, modalContent);
            }
        }
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ TON —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
        async function sendTonTransaction(transaction, transactionId, item, modalContent) {
            console.log('üì§ Sending TON transaction:', JSON.stringify(transaction, null, 2));
            
            modalContent.innerHTML = `
                <div style="text-align: center; padding: 30px;">
                    <div style="font-size: 64px; margin-bottom: 20px;">‚è≥</div>
                    <h2>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –≤ –∫–æ—à–µ–ª—å–∫–µ</h2>
                    <p style="margin: 15px 0;">–û—Ç–∫—Ä–æ–π—Ç–µ Tonkeeper/TON Space –∏ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –æ–ø–ª–∞—Ç—É ${item.price} TON</p>
                </div>
            `;

            try {
                console.log('üì§ Calling tonConnectUI.sendTransaction...');
                const result = await tonConnectUI.sendTransaction(transaction);
                console.log('TON Transaction result:', result);

                // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º –ø–ª–∞—Ç–µ–∂ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
                const confirmResponse = await fetch(`${API_URL}/api/shop/confirm-ton-payment`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${jwt}`
                    },
                    body: JSON.stringify({
                        userId: userId,
                        transactionId: transactionId,
                        txHash: result.boc
                    })
                });

                const confirmData = await confirmResponse.json();

                if (confirmData.success) {
                    if (tg?.HapticFeedback) {
                        tg.HapticFeedback.notificationOccurred('success');
                    }

                    modalContent.innerHTML = `
                        <div style="text-align: center; padding: 30px;">
                            <div style="font-size: 64px; margin-bottom: 20px;">üéâ</div>
                            <h2>–ü–æ–∫—É–ø–∫–∞ —É—Å–ø–µ—à–Ω–∞!</h2>
                            <p style="margin: 15px 0;">${item.name} –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å</p>
                            <p style="font-size: 14px; opacity: 0.7;">–û–ø–ª–∞—á–µ–Ω–æ: ${item.price} TON</p>
                            <button class="modal-button buy" onclick="closeModal(); loadPurchases(); loadBalance();" style="margin-top: 20px; width: 100%;">–û—Ç–ª–∏—á–Ω–æ!</button>
                        </div>
                    `;
                } else {
                    throw new Error(confirmData.error || '–û—à–∏–±–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è');
                }
            } catch (error) {
                handleTonError(error, modalContent);
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ TON
        function handleTonError(error, modalContent) {
            console.error('TON payment error:', error);
            
            // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–º–µ–Ω–∏–ª
            if (error?.message?.includes('User rejected') || error?.message?.includes('canceled')) {
                closeModal();
                return;
            }

            modalContent.innerHTML = `
                <div style="text-align: center; padding: 30px;">
                    <div style="font-size: 64px; margin-bottom: 20px;">‚ùå</div>
                    <h2>–û—à–∏–±–∫–∞ –æ–ø–ª–∞—Ç—ã</h2>
                    <p style="margin: 15px 0; opacity: 0.8;">${error.message || '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑'}</p>
                    <button class="modal-button buy" onclick="showManualPaymentOption()" style="margin-top: 15px; width: 100%;">–û–ø–ª–∞—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é</button>
                    <button class="modal-button cancel" onclick="closeModal()" style="margin-top: 10px; width: 100%;">–ó–∞–∫—Ä—ã—Ç—å</button>
                </div>
            `;
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å —Ä—É—á–Ω—É—é –æ–ø–ª–∞—Ç—É
        function showManualPaymentOption() {
            if (!pendingTonTransaction || !pendingItem) {
                closeModal();
                return;
            }
            const modalContent = document.querySelector('.modal-content');
            showManualTonPayment(pendingTonTransaction, pendingTransactionId, pendingItem, modalContent);
        }
        
        // –†—É—á–Ω–∞—è –æ–ø–ª–∞—Ç–∞ TON
        function showManualTonPayment(transaction, transactionId, item, modalContent) {
            modalContent.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <div style="font-size: 48px; margin-bottom: 15px;">üíé</div>
                    <h2 style="font-size: 18px;">–û–ø–ª–∞—Ç–∞ ${item.price} TON</h2>
                    <p style="margin: 10px 0; font-size: 13px;">–û—Ç–ø—Ä–∞–≤—å—Ç–µ TON –Ω–∞ –∞–¥—Ä–µ—Å:</p>
                    <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; margin: 10px 0; word-break: break-all; font-size: 11px;">
                        ${transaction.messages[0].address}
                    </div>
                    <button onclick="copyToClipboard('${transaction.messages[0].address}')" style="padding: 8px 16px; background: #0088cc; border: none; border-radius: 8px; color: white; cursor: pointer; margin-bottom: 10px;">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∞–¥—Ä–µ—Å</button>
                    <p style="font-size: 12px; opacity: 0.7; margin-top: 10px;">–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã —Ç–æ–≤–∞—Ä –ø–æ—è–≤–∏—Ç—Å—è –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ</p>
                    <button class="modal-button cancel" onclick="closeModal()" style="margin-top: 15px; width: 100%;">–ó–∞–∫—Ä—ã—Ç—å</button>
                </div>
            `;
        }
        
        // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –±—É—Ñ–µ—Ä
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                if (tg?.HapticFeedback) {
                    tg.HapticFeedback.notificationOccurred('success');
                }
                alert('–ê–¥—Ä–µ—Å —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!');
            });
        }
        
        // –ü–æ–¥–∫–ª—é—á–∏—Ç—å –∏ –æ–ø–ª–∞—Ç–∏—Ç—å
        async function connectAndPayTon() {
            try {
                const TonConnectUIClass = window.TON_CONNECT_UI?.TonConnectUI || window.TonConnectUI;
                if (!tonConnectUI && TonConnectUIClass) {
                    tonConnectUI = new TonConnectUIClass({
                        manifestUrl: 'https://monkey-flipper-djm1.onrender.com/tonconnect-manifest.json',
                        buttonRootId: null
                    });
                }
                
                if (tonConnectUI) {
                    await tonConnectUI.connectWallet();
                    
                    // –ü–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
                    if (tonConnectUI.wallet && pendingTonTransaction) {
                        const modalContent = document.querySelector('.modal-content');
                        await sendTonTransaction(pendingTonTransaction, pendingTransactionId, pendingItem, modalContent);
                    }
                }
            } catch (error) {
                console.error('Connect and pay error:', error);
                if (!error?.message?.includes('User rejected')) {
                    const modalContent = document.querySelector('.modal-content');
                    handleTonError(error, modalContent);
                }
            }
        }

        // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ TON –∫–æ—à–µ–ª—å–∫–∞ –∏–∑ –º–∞–≥–∞–∑–∏–Ω–∞
        async function connectTonWallet() {
            try {
                const TonConnectUIClass = window.TON_CONNECT_UI?.TonConnectUI || window.TonConnectUI;
                if (!tonConnectUI && TonConnectUIClass) {
                    tonConnectUI = new TonConnectUIClass({
                        manifestUrl: 'https://monkey-flipper-djm1.onrender.com/tonconnect-manifest.json',
                        buttonRootId: null
                    });
                }
                if (tonConnectUI) {
                    await tonConnectUI.connectWallet();
                }
                closeModal();
            } catch (error) {
                console.error('Connect wallet error:', error);
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
        function showError(message) {
            document.getElementById('shopContent').innerHTML = `
                <div class="error">${message}</div>
            `;
        }

        // –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        init();
    </script>
</body>
</html>