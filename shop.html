<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ú–∞–≥–∞–∑–∏–Ω - Monkey Flipper</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            overflow-x: hidden;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .balance-section {
            display: flex;
            justify-content: space-around;
            margin-bottom: 30px;
            gap: 10px;
        }

        .balance-card {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            padding: 15px 25px;
            border-radius: 15px;
            text-align: center;
            flex: 1;
            border: 2px solid rgba(255,255,255,0.2);
        }

        .balance-card .label {
            font-size: 12px;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .balance-card .amount {
            font-size: 24px;
            font-weight: bold;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 10px;
        }

        .tab {
            padding: 10px 20px;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 20px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s;
        }

        .tab.active {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.5);
            transform: scale(1.05);
        }

        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 80px;
        }

        .item-card {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            border: 2px solid rgba(255,255,255,0.2);
            transition: transform 0.3s;
            cursor: pointer;
        }

        .item-card:hover {
            transform: translateY(-5px);
            border-color: rgba(255,255,255,0.5);
        }

        .item-card .icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .item-card .name {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .item-card .description {
            font-size: 11px;
            opacity: 0.8;
            margin-bottom: 10px;
            line-height: 1.3;
        }

        .item-card .price {
            font-size: 16px;
            font-weight: bold;
            padding: 8px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
        }

        .item-card .price.coins {
            color: #FFD700;
        }

        .item-card .price.stars {
            color: #00D8FF;
        }

        .back-button {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 40px;
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 25px;
            color: #fff;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .back-button:hover {
            background: rgba(255,255,255,0.3);
            transform: translateX(-50%) scale(1.05);
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
        }

        .error {
            background: rgba(255,0,0,0.2);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            border-radius: 20px;
            max-width: 400px;
            width: 100%;
            text-align: center;
            border: 2px solid rgba(255,255,255,0.3);
        }

        .modal-content .icon {
            font-size: 72px;
            margin-bottom: 15px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .modal-button:hover {
            transform: scale(1.05);
        }

        .modal-button.buy {
            background: #4CAF50;
            color: white;
        }

        .modal-button.cancel {
            background: rgba(255,255,255,0.2);
            color: white;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üõçÔ∏è –ú–∞–≥–∞–∑–∏–Ω</h1>
        <button onclick="goToGame()" style="margin-top: 10px; padding: 10px 20px; background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.3); border-radius: 10px; color: white; font-size: 16px; cursor: pointer;">
            üéÆ –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –∏–≥—Ä—É
        </button>
    </div>

    <div class="balance-section">
        <div class="balance-card">
            <div class="label">Monkey Coins</div>
            <div class="amount" id="coinsBalance">...</div>
        </div>
        <div class="balance-card">
            <div class="label">STARS</div>
            <div class="amount" id="starsBalance">...</div>
        </div>
    </div>

    <div class="tabs">
        <div class="tab active" data-category="all">–í—Å—ë</div>
        <div class="tab" data-category="skins">–°–∫–∏–Ω—ã</div>
        <div class="tab" data-category="nfts">NFT</div>
        <div class="tab" data-category="boosts">–ë—É—Å—Ç—ã</div>
    </div>

    <div id="shopContent" class="items-grid">
        <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –º–∞–≥–∞–∑–∏–Ω–∞...</div>
    </div>

    <button class="back-button" onclick="goBack()">‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –≤ –∏–≥—Ä—É</button>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–æ–∫—É–ø–∫–∏ -->
    <div id="buyModal" class="modal">
        <div class="modal-content">
            <div class="icon" id="modalIcon">üé®</div>
            <h2 id="modalTitle">–ö—É–ø–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç?</h2>
            <p id="modalDescription"></p>
            <p id="modalPrice"></p>
            <div class="modal-buttons">
                <button class="modal-button cancel" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="modal-button buy" onclick="confirmBuy()">–ö—É–ø–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è API
        const API_URL = window.location.hostname === 'localhost'
            ? 'http://localhost:3001'
            : 'https://monkey-flipper-djm1.onrender.com';

        // Telegram WebApp
        const tg = window.Telegram?.WebApp;
        if (tg) {
            tg.ready();
            tg.expand();
        }

        // –°–æ—Å—Ç–æ—è–Ω–∏–µ
        let userId = null;
        let jwt = null;
        let shopItems = [];
        let selectedItem = null;
        let currentCategory = 'all';

        // –ü–µ—Ä–µ—Ö–æ–¥ –≤ –∏–≥—Ä—É
        function goToGame() {
            if (tg) {
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º Web App –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –±–æ—Ç—É
                tg.close();
            } else {
                // –í –±—Ä–∞—É–∑–µ—Ä–µ - –æ—Ç–∫—Ä—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
                window.location.href = '/index.html';
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        async function init() {
            try {
                // –ü–æ–ª—É—á–∞–µ–º userId –∏–∑ Telegram
                if (tg?.initDataUnsafe?.user) {
                    userId = tg.initDataUnsafe.user.id;
                } else {
                    // –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –±–µ–∑ Telegram
                    userId = 123456;
                    console.warn('‚ö†Ô∏è Telegram –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π userId');
                }

                // –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
                await authenticate();

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                await Promise.all([
                    loadBalance(),
                    loadShopItems()
                ]);

                setupTabs();
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ' + error.message);
            }
        }

        // –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
        async function authenticate() {
            try {
                const initData = tg?.initData || 'test_mode';
                const response = await fetch(`${API_URL}/api/auth/telegram`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ initData })
                });

                const data = await response.json();
                if (data.success) {
                    jwt = data.token;
                    userId = data.userId;
                    console.log('‚úÖ –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞');
                } else {
                    throw new Error(data.error || '–û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏');
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:', error);
                throw error;
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–ª–∞–Ω—Å–∞
        async function loadBalance() {
            try {
                const response = await fetch(`${API_URL}/api/wallet/balance?userId=${userId}`, {
                    headers: { 'Authorization': `Bearer ${jwt}` }
                });

                const data = await response.json();
                if (data.success) {
                    document.getElementById('coinsBalance').textContent = data.balance.coins.toLocaleString();
                    document.getElementById('starsBalance').textContent = data.balance.stars.toLocaleString();
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–ª–∞–Ω—Å–∞:', error);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤
        async function loadShopItems() {
            try {
                const response = await fetch(`${API_URL}/api/shop/items`, {
                    headers: { 'Authorization': `Bearer ${jwt}` }
                });

                const data = await response.json();
                if (data.success) {
                    shopItems = data.items;
                    renderItems();
                }
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞–≥–∞–∑–∏–Ω–∞: ' + error.message);
            }
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤
        function renderItems() {
            const container = document.getElementById('shopContent');
            const filtered = currentCategory === 'all' 
                ? shopItems 
                : shopItems.filter(item => item.category === currentCategory);

            if (filtered.length === 0) {
                container.innerHTML = '<div class="loading">–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                return;
            }

            container.innerHTML = filtered.map(item => {
                let priceHtml = '';
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ–ø–ª–∞—Ç—ã
                if (item.currency === 'both') {
                    priceHtml = `
                        <div class="price coins" style="margin-bottom: 5px">
                            ü™ô ${item.priceCoins || item.priceStars * 20} Coins
                        </div>
                        <div class="price stars" style="margin-bottom: 5px">
                            üí∞ ${item.priceStars} STARS
                        </div>
                        <div class="price" style="background: linear-gradient(135deg, #667eea, #764ba2); color: #fff">
                            ‚≠ê ${item.priceXTR} XTR
                        </div>
                    `;
                } else if (item.currency === 'coins') {
                    priceHtml = `<div class="price coins">ü™ô ${item.priceCoins}</div>`;
                } else {
                    priceHtml = `<div class="price stars">üí∞ ${item.priceStars || item.price} STARS</div>`;
                }
                
                return `
                    <div class="item-card" onclick="showBuyModal('${item.id}')">
                        <div class="icon">${getItemIcon(item.category)}</div>
                        <div class="name">${item.name}</div>
                        <div class="description">${item.description}</div>
                        ${priceHtml}
                    </div>
                `;
            }).join('');
        }

        // –ò–∫–æ–Ω–∫–∏ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        function getItemIcon(category) {
            const icons = {
                skins: 'üé®',
                nfts: 'üñºÔ∏è',
                boosts: '‚ö°',
                cosmetic: '‚ú®'
            };
            return icons[category] || 'üéÅ';
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–∫—É–ø–∫–∏
        function showBuyModal(itemId) {
            selectedItem = shopItems.find(item => item.id === itemId);
            if (!selectedItem) return;

            document.getElementById('modalIcon').textContent = getItemIcon(selectedItem.category);
            document.getElementById('modalTitle').textContent = selectedItem.name;
            document.getElementById('modalDescription').textContent = selectedItem.description;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ–ø–ª–∞—Ç—ã
            let priceText = '–¶–µ–Ω–∞:<br>';
            if (selectedItem.currency === 'both') {
                priceText += `
                    ü™ô <strong>${selectedItem.priceCoins || selectedItem.priceStars * 20} Monkey Coins</strong><br>
                    üí∞ <strong>${selectedItem.priceStars} STARS (–∏–≥—Ä–æ–≤—ã–µ)</strong><br>
                    ‚≠ê <strong>${selectedItem.priceXTR} Telegram Stars (XTR)</strong>
                `;
            } else if (selectedItem.currency === 'coins') {
                priceText += `ü™ô <strong>${selectedItem.priceCoins} Monkey Coins</strong>`;
            } else {
                priceText += `üí∞ <strong>${selectedItem.priceStars || selectedItem.price} STARS</strong>`;
            }
            
            document.getElementById('modalPrice').innerHTML = priceText;

            document.getElementById('buyModal').classList.add('active');

            // –í–∏–±—Ä–∞—Ü–∏—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª–∫–∏
            if (tg?.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('light');
            }
        }

        // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        function closeModal() {
            document.getElementById('buyModal').classList.remove('active');
            selectedItem = null;
            selectedPaymentMethod = null;
        }
        
        let selectedPaymentMethod = null;

        // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ–∫—É–ø–∫–∏
        async function confirmBuy() {
            if (!selectedItem) return;
            
            // –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–ø–æ—Å–æ–±–æ–≤ –æ–ø–ª–∞—Ç—ã - —Å–ø—Ä–∞—à–∏–≤–∞–µ–º –∫–∞–∫–æ–π –≤—ã–±—Ä–∞—Ç—å
            if (selectedItem.currency === 'both' && !selectedPaymentMethod) {
                const choice = prompt('–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã:\n1 - Monkey Coins\n2 - STARS (–∏–≥—Ä–æ–≤—ã–µ)\n3 - Telegram Stars (XTR)', '1');
                if (choice === '1') selectedPaymentMethod = 'coins';
                else if (choice === '2') selectedPaymentMethod = 'stars';
                else if (choice === '3') selectedPaymentMethod = 'xtr';
                else return;
            }

            try {
                let endpoint, body;
                
                if (selectedPaymentMethod === 'xtr' || (selectedItem.currency === 'xtr')) {
                    // –ü–æ–∫—É–ø–∫–∞ –∑–∞ Telegram Stars (XTR) - —Å–æ–∑–¥–∞–µ–º –∏–Ω–≤–æ–π—Å
                    endpoint = '/api/shop/create-stars-invoice';
                    body = {
                        userId: userId,
                        itemId: selectedItem.id
                    };
                } else if (selectedPaymentMethod === 'coins' || selectedItem.currency === 'coins') {
                    // –ü–æ–∫—É–ø–∫–∞ –∑–∞ Monkey Coins
                    endpoint = '/api/shop/buy';
                    body = {
                        userId: userId,
                        itemId: selectedItem.id
                    };
                } else {
                    // –ü–æ–∫—É–ø–∫–∞ –∑–∞ –∏–≥—Ä–æ–≤—ã–µ STARS
                    endpoint = '/api/shop/buy-stars';
                    body = {
                        userId: userId,
                        itemId: selectedItem.id,
                        signature: 'client_signature_placeholder'
                    };
                }

                const response = await fetch(`${API_URL}${endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${jwt}`
                    },
                    body: JSON.stringify(body)
                });

                const data = await response.json();
                
                if (data.success) {
                    if (data.invoice) {
                        // Telegram Stars (XTR) - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–≤–æ–π—Å
                        if (tg?.HapticFeedback) {
                            tg.HapticFeedback.notificationOccurred('success');
                        }
                        alert(`‚úÖ –ò–Ω–≤–æ–π—Å —Å–æ–∑–¥–∞–Ω!\n–ü–ª–∞—Ç–µ–∂ –±—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω —á–µ—Ä–µ–∑ Telegram Stars.\n–°—É–º–º–∞: ${selectedItem.priceXTR} XTR`);
                        closeModal();
                        // TODO: –û—Ç–∫—Ä—ã—Ç—å –∏–Ω–≤–æ–π—Å –≤ Telegram
                    } else {
                        // –û–±—ã—á–Ω–∞—è –ø–æ–∫—É–ø–∫–∞ –∑–∞ Coins/STARS
                        if (tg?.HapticFeedback) {
                            tg.HapticFeedback.notificationOccurred('success');
                        }
                        
                        const balanceText = data.newBalance ? `\n–ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: ${data.newBalance.toLocaleString()}` : '';
                        alert(`‚úÖ –ö—É–ø–ª–µ–Ω–æ: ${selectedItem.name}!${balanceText}`);
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å
                        await loadBalance();
                        closeModal();
                    }
                } else {
                    throw new Error(data.error || '–û—à–∏–±–∫–∞ –ø–æ–∫—É–ø–∫–∏');
                }
            } catch (error) {
                if (tg?.HapticFeedback) {
                    tg.HapticFeedback.notificationOccurred('error');
                }
                alert('‚ùå ' + error.message);
            }
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–∞–±–æ–≤
        function setupTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentCategory = tab.dataset.category;
                    renderItems();

                    if (tg?.HapticFeedback) {
                        tg.HapticFeedback.impactOccurred('light');
                    }
                });
            });
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
        function showError(message) {
            document.getElementById('shopContent').innerHTML = `
                <div class="error">${message}</div>
            `;
        }

        // –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –∏–≥—Ä—É
        function goBack() {
            window.location.href = 'index.html';
        }

        // –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        init();
    </script>
</body>
</html>
