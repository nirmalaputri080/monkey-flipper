<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ú–∞–≥–∞–∑–∏–Ω - Monkey Flipper</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            overflow-x: hidden;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .balance-section {
            display: flex;
            justify-content: space-around;
            margin-bottom: 30px;
            gap: 10px;
        }

        .balance-card {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            padding: 15px 25px;
            border-radius: 15px;
            text-align: center;
            flex: 1;
            border: 2px solid rgba(255,255,255,0.2);
        }

        .balance-card .label {
            font-size: 12px;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .balance-card .amount {
            font-size: 24px;
            font-weight: bold;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 10px;
        }

        .tab {
            padding: 10px 20px;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 20px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s;
        }

        .tab.active {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.5);
            transform: scale(1.05);
        }

        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 80px;
        }

        .item-card {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            border: 2px solid rgba(255,255,255,0.2);
            transition: transform 0.3s;
            cursor: pointer;
        }

        .item-card:hover {
            transform: translateY(-5px);
            border-color: rgba(255,255,255,0.5);
        }

        .item-card .icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .item-card .name {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .item-card .description {
            font-size: 11px;
            opacity: 0.8;
            margin-bottom: 10px;
            line-height: 1.3;
        }

        .item-card .price {
            font-size: 16px;
            font-weight: bold;
            padding: 8px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
        }

        .item-card .price.coins {
            color: #FFD700;
        }

        .item-card .price.stars {
            color: #00D8FF;
        }

        .back-button {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 40px;
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 25px;
            color: #fff;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .back-button:hover {
            background: rgba(255,255,255,0.3);
            transform: translateX(-50%) scale(1.05);
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
        }

        .error {
            background: rgba(255,0,0,0.2);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            border-radius: 20px;
            max-width: 400px;
            width: 100%;
            text-align: center;
            border: 2px solid rgba(255,255,255,0.3);
        }

        .modal-content .icon {
            font-size: 72px;
            margin-bottom: 15px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .modal-button:hover {
            transform: scale(1.05);
        }

        .modal-button.buy {
            background: #4CAF50;
            color: white;
        }

        .modal-button.cancel {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .payment-methods {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }

        .payment-button {
            padding: 15px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 12px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .payment-button:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
            border-color: rgba(255,255,255,0.5);
        }

        .payment-button:active {
            transform: translateY(0);
        }

        .payment-button .icon {
            font-size: 24px;
            margin-right: 10px;
        }

        .payment-button .price {
            font-size: 18px;
            font-weight: bold;
        }

        #singlePaymentSection {
            display: none;
        }

        #multiPaymentSection {
            display: none;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üõçÔ∏è –ú–∞–≥–∞–∑–∏–Ω</h1>
        <button onclick="goToGame()" style="margin-top: 10px; padding: 10px 20px; background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.3); border-radius: 10px; color: white; font-size: 16px; cursor: pointer;">
            üéÆ –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –∏–≥—Ä—É
        </button>
    </div>

    <div class="balance-section">
        <div class="balance-card">
            <div class="label">Monkey Coins</div>
            <div class="amount" id="coinsBalance">...</div>
        </div>
        <div class="balance-card">
            <div class="label">STARS</div>
            <div class="amount" id="starsBalance">...</div>
        </div>
    </div>

    <div class="tabs">
        <div class="tab active" data-category="all">–í—Å—ë</div>
        <div class="tab" data-category="skins">–°–∫–∏–Ω—ã</div>
        <div class="tab" data-category="nfts">NFT</div>
        <div class="tab" data-category="boosts">–ë—É—Å—Ç—ã</div>
    </div>

    <div id="shopContent" class="items-grid">
        <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –º–∞–≥–∞–∑–∏–Ω–∞...</div>
    </div>

    <button class="back-button" onclick="goBack()">‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –≤ –∏–≥—Ä—É</button>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–æ–∫—É–ø–∫–∏ -->
    <div id="buyModal" class="modal">
        <div class="modal-content">
            <div class="icon" id="modalIcon">üé®</div>
            <h2 id="modalTitle">–ö—É–ø–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç?</h2>
            <p id="modalDescription"></p>
            
            <!-- –û–¥–∏–Ω —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã -->
            <div id="singlePaymentSection">
                <p id="modalPrice"></p>
                <div class="modal-buttons">
                    <button class="modal-button cancel" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
                    <button class="modal-button buy" onclick="confirmBuy()">–ö—É–ø–∏—Ç—å</button>
                </div>
            </div>
            
            <!-- –ù–µ—Å–∫–æ–ª—å–∫–æ —Å–ø–æ—Å–æ–±–æ–≤ –æ–ø–ª–∞—Ç—ã -->
            <div id="multiPaymentSection">
                <p style="margin-bottom: 15px; font-size: 14px;">–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã:</p>
                <div class="payment-methods">
                    <button class="payment-button" id="payCoins" onclick="selectPayment('coins')" style="display: none;">
                        <span><span class="icon">ü™ô</span> Monkey Coins</span>
                        <span class="price" id="priceCoins">0</span>
                    </button>
                    <button class="payment-button" id="payStars" onclick="selectPayment('stars')" style="display: none;">
                        <span><span class="icon">üí∞</span> STARS (–∏–≥—Ä–æ–≤—ã–µ)</span>
                        <span class="price" id="priceStars">0</span>
                    </button>
                    <button class="payment-button" id="payXTR" onclick="selectPayment('xtr')" style="display: none;">
                        <span><span class="icon">‚≠ê</span> Telegram Stars</span>
                        <span class="price" id="priceXTR">0</span>
                    </button>
                </div>
                <button class="modal-button cancel" onclick="closeModal()" style="margin-top: 15px; width: 100%;">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è API
        const API_URL = window.location.hostname === 'localhost'
            ? 'http://localhost:3001'
            : 'https://monkey-flipper-djm1.onrender.com';

        // Telegram WebApp
        const tg = window.Telegram?.WebApp;
        if (tg) {
            tg.ready();
            tg.expand();
        }

        // –°–æ—Å—Ç–æ—è–Ω–∏–µ
        let userId = null;
        let jwt = null;
        let shopItems = [];
        let purchasedItems = []; // –°–ø–∏—Å–æ–∫ –∫—É–ø–ª–µ–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤
        let selectedItem = null;
        let currentCategory = 'all';

        // –ü–µ—Ä–µ—Ö–æ–¥ –≤ –∏–≥—Ä—É
        function goToGame() {
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É (–≥–¥–µ –∏–≥—Ä–∞)
            window.location.href = '/index.html';
        }
        
        // –ê–ª–∏–∞—Å –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
        const goBack = goToGame;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        async function init() {
            try {
                // –ü–æ–ª—É—á–∞–µ–º userId –∏–∑ Telegram (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: WebApp > URL –ø–∞—Ä–∞–º–µ—Ç—Ä)
                if (tg?.initDataUnsafe?.user?.id) {
                    userId = tg.initDataUnsafe.user.id;
                    console.log('‚úÖ userId –∏–∑ Telegram WebApp:', userId);
                } else {
                    // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –∏–∑ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ (–ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –∏–∑ –∏–≥—Ä—ã)
                    const urlParams = new URLSearchParams(window.location.search);
                    const urlUserId = urlParams.get('userId');
                    
                    if (urlUserId && urlUserId !== 'unknown' && !urlUserId.includes('anonymous')) {
                        userId = parseInt(urlUserId);
                        console.log('‚ö†Ô∏è userId –∏–∑ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–∞:', userId);
                    } else {
                        // –ü–æ—Å–ª–µ–¥–Ω–∏–π –≤–∞—Ä–∏–∞–Ω—Ç - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
                        throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –û—Ç–∫—Ä–æ–π—Ç–µ –º–∞–≥–∞–∑–∏–Ω –∏–∑ Telegram –±–æ—Ç–∞.');
                    }
                }

                // –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
                await authenticate();

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                await Promise.all([
                    loadBalance(),
                    loadShopItems(),
                    loadPurchases()
                ]);

                setupTabs();
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ' + error.message);
            }
        }

        // –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
        async function authenticate() {
            try {
                // –î–ª—è –º–∞–≥–∞–∑–∏–Ω–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º —É–ø—Ä–æ—â–µ–Ω–Ω—É—é –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø—Ä–æ—Å—Ç–æ–π JWT —Ç–æ–∫–µ–Ω –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ API
                const initData = tg?.initData || '';
                
                // –ï—Å–ª–∏ –µ—Å—Ç—å Telegram –¥–∞–Ω–Ω—ã–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏—Ö –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–æ–∫–µ–Ω–∞
                if (initData && userId) {
                    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø—Ä–æ—Å—Ç–æ–π —Ç–æ–∫–µ–Ω –Ω–∞ –æ—Å–Ω–æ–≤–µ userId
                    jwt = btoa(`user_${userId}_${Date.now()}`);
                    console.log('‚úÖ –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram —É—Å–ø–µ—à–Ω–∞');
                } else {
                    // –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º –±–µ–∑ Telegram
                    jwt = btoa(`test_${userId}_${Date.now()}`);
                    console.log('‚ö†Ô∏è –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏');
                }
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:', error);
                // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ä–∞–±–æ—Ç—É –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
                jwt = btoa(`fallback_${userId}_${Date.now()}`);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–ª–∞–Ω—Å–∞
        async function loadBalance() {
            try {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π endpoint /api/wallet/:userId
                const response = await fetch(`${API_URL}/api/wallet/${userId}`, {
                    headers: { 'Authorization': `Bearer ${jwt}` }
                });

                const data = await response.json();
                if (data.success && data.wallet) {
                    document.getElementById('coinsBalance').textContent = (data.wallet.monkeyCoin || 0).toLocaleString();
                    document.getElementById('starsBalance').textContent = (parseFloat(data.wallet.stars) || 0).toLocaleString();
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–ª–∞–Ω—Å–∞:', error);
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º 0 –ø—Ä–∏ –æ—à–∏–±–∫–µ
                document.getElementById('coinsBalance').textContent = '0';
                document.getElementById('starsBalance').textContent = '0';
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤
        async function loadShopItems() {
            try {
                const response = await fetch(`${API_URL}/api/shop/items`, {
                    headers: { 'Authorization': `Bearer ${jwt}` }
                });

                const data = await response.json();
                if (data.success && data.items) {
                    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –æ–±—ä–µ–∫—Ç —Å –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ –≤ –ø–ª–æ—Å–∫–∏–π –º–∞—Å—Å–∏–≤
                    shopItems = [];
                    if (data.items.skins) shopItems = shopItems.concat(data.items.skins);
                    if (data.items.nft_characters) shopItems = shopItems.concat(data.items.nft_characters);
                    if (data.items.boosts) shopItems = shopItems.concat(data.items.boosts);
                    if (data.items.monkey_coin_items) shopItems = shopItems.concat(data.items.monkey_coin_items);
                    
                    console.log('‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤:', shopItems.length);
                    renderItems();
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞:', error);
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞–≥–∞–∑–∏–Ω–∞: ' + error.message);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∫—É–ø–ª–µ–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤
        async function loadPurchases() {
            try {
                const response = await fetch(`${API_URL}/api/shop/purchases/${userId}`, {
                    headers: { 'Authorization': `Bearer ${jwt}` }
                });

                const data = await response.json();
                if (data.success && data.purchases) {
                    purchasedItems = data.purchases.map(p => p.item_id);
                    console.log('‚úÖ –ö—É–ø–ª–µ–Ω–æ –ø—Ä–µ–¥–º–µ—Ç–æ–≤:', purchasedItems.length, purchasedItems);
                    renderItems(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–∫—É–ø–æ–∫
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–∫—É–ø–æ–∫:', error);
            }
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤
        function renderItems() {
            const container = document.getElementById('shopContent');
            const filtered = currentCategory === 'all' 
                ? shopItems 
                : shopItems.filter(item => item.category === currentCategory);

            if (filtered.length === 0) {
                container.innerHTML = '<div class="loading">–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                return;
            }

            container.innerHTML = filtered.map(item => {
                const isPurchased = purchasedItems.includes(item.id);
                let priceHtml = '';
                
                if (isPurchased) {
                    // –ï—Å–ª–∏ –∫—É–ø–ª–µ–Ω–æ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å
                    priceHtml = `<div class="price" style="background: #4CAF50; color: white; font-weight: bold;">‚úÖ –ö–£–ü–õ–ï–ù–û</div>`;
                } else {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ–ø–ª–∞—Ç—ã
                    if (item.currency === 'both') {
                        priceHtml = `
                            <div class="price coins" style="margin-bottom: 5px">
                                ü™ô ${item.priceCoins || item.priceStars * 20} Coins
                            </div>
                            <div class="price stars" style="margin-bottom: 5px">
                                üí∞ ${item.priceStars} STARS
                            </div>
                            <div class="price" style="background: linear-gradient(135deg, #667eea, #764ba2); color: #fff">
                                ‚≠ê ${item.priceXTR} XTR
                            </div>
                        `;
                    } else if (item.currency === 'coins') {
                        priceHtml = `<div class="price coins">ü™ô ${item.priceCoins}</div>`;
                    } else {
                        priceHtml = `<div class="price stars">üí∞ ${item.priceStars || item.price} STARS</div>`;
                    }
                }
                
                return `
                    <div class="item-card" onclick="${isPurchased ? '' : `showBuyModal('${item.id}')`}" style="${isPurchased ? 'opacity: 0.7; cursor: default;' : ''}">
                        <div class="icon">${getItemIcon(item.category)}</div>
                        <div class="name">${item.name}</div>
                        <div class="description">${item.description}</div>
                        ${priceHtml}
                    </div>
                `;
            }).join('');
        }

        // –ò–∫–æ–Ω–∫–∏ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        function getItemIcon(category) {
            const icons = {
                skins: 'üé®',
                nfts: 'üñºÔ∏è',
                boosts: '‚ö°',
                cosmetic: '‚ú®'
            };
            return icons[category] || 'üéÅ';
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–∫—É–ø–∫–∏
        function showBuyModal(itemId) {
            selectedItem = shopItems.find(item => item.id === itemId);
            if (!selectedItem) return;

            document.getElementById('modalIcon').textContent = getItemIcon(selectedItem.category);
            document.getElementById('modalTitle').textContent = selectedItem.name;
            document.getElementById('modalDescription').textContent = selectedItem.description;
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä –º–µ—Ç–æ–¥–∞ –æ–ø–ª–∞—Ç—ã
            selectedPaymentMethod = null;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∫–æ–ª—å–∫–æ —Å–ø–æ—Å–æ–±–æ–≤ –æ–ø–ª–∞—Ç—ã –¥–æ—Å—Ç—É–ø–Ω–æ
            if (selectedItem.currency === 'both') {
                // –ù–µ—Å–∫–æ–ª—å–∫–æ —Å–ø–æ—Å–æ–±–æ–≤ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞
                document.getElementById('singlePaymentSection').style.display = 'none';
                document.getElementById('multiPaymentSection').style.display = 'block';
                
                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –æ–ø–ª–∞—Ç—ã
                if (selectedItem.priceCoins) {
                    document.getElementById('payCoins').style.display = 'flex';
                    document.getElementById('priceCoins').textContent = `${selectedItem.priceCoins} ü™ô`;
                }
                if (selectedItem.priceStars) {
                    document.getElementById('payStars').style.display = 'flex';
                    document.getElementById('priceStars').textContent = `${selectedItem.priceStars} üí∞`;
                }
                if (selectedItem.priceXTR) {
                    document.getElementById('payXTR').style.display = 'flex';
                    document.getElementById('priceXTR').textContent = `${selectedItem.priceXTR} ‚≠ê`;
                }
            } else {
                // –û–¥–∏–Ω —Å–ø–æ—Å–æ–± - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—ã—á–Ω—É—é –∫–Ω–æ–ø–∫—É –ø–æ–∫—É–ø–∫–∏
                document.getElementById('singlePaymentSection').style.display = 'block';
                document.getElementById('multiPaymentSection').style.display = 'none';
                
                let priceText = '';
                if (selectedItem.currency === 'coins') {
                    priceText = `ü™ô <strong>${selectedItem.priceCoins} Monkey Coins</strong>`;
                    selectedPaymentMethod = 'coins';
                } else if (selectedItem.currency === 'xtr') {
                    priceText = `‚≠ê <strong>${selectedItem.priceXTR} Telegram Stars</strong>`;
                    selectedPaymentMethod = 'xtr';
                } else {
                    priceText = `üí∞ <strong>${selectedItem.priceStars || selectedItem.price} STARS</strong>`;
                    selectedPaymentMethod = 'stars';
                }
                
                document.getElementById('modalPrice').innerHTML = priceText;
            }

            document.getElementById('buyModal').classList.add('active');

            // –í–∏–±—Ä–∞—Ü–∏—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª–∫–∏
            if (tg?.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('light');
            }
        }

        // –í—ã–±–æ—Ä —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã
        function selectPayment(method) {
            selectedPaymentMethod = method;
            console.log('üí≥ –í—ã–±—Ä–∞–Ω —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã:', method);
            confirmBuy();
        }

        // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        function closeModal() {
            document.getElementById('buyModal').classList.remove('active');
            selectedItem = null;
            selectedPaymentMethod = null;
            
            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –∫–Ω–æ–ø–∫–∏ –æ–ø–ª–∞—Ç—ã
            document.getElementById('payCoins').style.display = 'none';
            document.getElementById('payStars').style.display = 'none';
            document.getElementById('payXTR').style.display = 'none';
        }
        
        let selectedPaymentMethod = null;

        // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ–∫—É–ø–∫–∏
        async function confirmBuy() {
            if (!selectedItem) return;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –º–µ—Ç–æ–¥ –æ–ø–ª–∞—Ç—ã –≤—ã–±—Ä–∞–Ω
            if (!selectedPaymentMethod) {
                console.error('‚ùå –ú–µ—Ç–æ–¥ –æ–ø–ª–∞—Ç—ã –Ω–µ –≤—ã–±—Ä–∞–Ω');
                return;
            }
            
            console.log('üõí –ü–æ–∫—É–ø–∫–∞:', selectedItem.name, '–∑–∞', selectedPaymentMethod);

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            const modalContent = document.querySelector('.modal-content');
            const originalHTML = modalContent.innerHTML;
            modalContent.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 48px; margin-bottom: 20px;">‚è≥</div>
                    <h2>–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–∞...</h2>
                    <p style="opacity: 0.8;">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ</p>
                </div>
            `;

            try {
                let endpoint, body;
                
                if (selectedPaymentMethod === 'xtr' || (selectedItem.currency === 'xtr')) {
                    // –ü–æ–∫—É–ø–∫–∞ –∑–∞ Telegram Stars (XTR) - —Å–æ–∑–¥–∞–µ–º –∏–Ω–≤–æ–π—Å
                    endpoint = '/api/shop/create-stars-invoice';
                    body = {
                        userId: userId,
                        itemId: selectedItem.id
                    };
                } else if (selectedPaymentMethod === 'coins' || selectedItem.currency === 'coins') {
                    // –ü–æ–∫—É–ø–∫–∞ –∑–∞ Monkey Coins
                    endpoint = '/api/shop/purchase';
                    body = {
                        userId: userId,
                        itemId: selectedItem.id,
                        itemName: selectedItem.name,
                        price: selectedItem.priceCoins,
                        category: selectedItem.category
                    };
                } else {
                    // –ü–æ–∫—É–ø–∫–∞ –∑–∞ –∏–≥—Ä–æ–≤—ã–µ STARS
                    endpoint = '/api/shop/purchase-stars';
                    body = {
                        userId: userId,
                        itemId: selectedItem.id,
                        itemName: selectedItem.name,
                        priceStars: selectedItem.priceStars,
                        signature: 'client_signature_placeholder'
                    };
                }

                const response = await fetch(`${API_URL}${endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${jwt}`
                    },
                    body: JSON.stringify(body)
                });

                const data = await response.json();
                
                if (data.success) {
                    if (data.invoice) {
                        // Telegram Stars (XTR) - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–≤–æ–π—Å
                        if (tg?.HapticFeedback) {
                            tg.HapticFeedback.notificationOccurred('success');
                        }
                        
                        modalContent.innerHTML = `
                            <div style="text-align: center; padding: 30px;">
                                <div style="font-size: 64px; margin-bottom: 20px;">‚úÖ</div>
                                <h2>–ò–Ω–≤–æ–π—Å —Å–æ–∑–¥–∞–Ω!</h2>
                                <p style="margin: 15px 0;">–ü–ª–∞—Ç–µ–∂ –±—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω —á–µ—Ä–µ–∑ Telegram Stars</p>
                                <p style="font-size: 20px; font-weight: bold; color: #FFD700;">‚≠ê ${selectedItem.priceXTR} XTR</p>
                                <button class="modal-button buy" onclick="closeModal()" style="margin-top: 20px; width: 100%;">–ü–æ–Ω—è—Ç–Ω–æ</button>
                            </div>
                        `;
                        
                        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–∫—É–ø–∫–∏ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                        setTimeout(() => {
                            loadPurchases();
                        }, 2000);
                    } else {
                        // –û–±—ã—á–Ω–∞—è –ø–æ–∫—É–ø–∫–∞ –∑–∞ Coins/STARS - –£–°–ü–ï–•!
                        if (tg?.HapticFeedback) {
                            tg.HapticFeedback.notificationOccurred('success');
                        }
                        
                        const balanceText = data.newBalance ? `–ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: ${data.newBalance.toLocaleString()} ü™ô` : '';
                        
                        modalContent.innerHTML = `
                            <div style="text-align: center; padding: 30px;">
                                <div style="font-size: 64px; margin-bottom: 20px;">üéâ</div>
                                <h2>–ü–æ–∫—É–ø–∫–∞ —É—Å–ø–µ—à–Ω–∞!</h2>
                                <p style="margin: 15px 0; font-size: 18px; font-weight: bold;">${selectedItem.name}</p>
                                <p style="opacity: 0.8;">‚úÖ –ü—Ä–µ–¥–º–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ –≤–∞—à –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å</p>
                                ${balanceText ? `<p style="margin-top: 10px; font-size: 14px;">${balanceText}</p>` : ''}
                                <button class="modal-button buy" onclick="closeModal()" style="margin-top: 20px; width: 100%;">–û—Ç–ª–∏—á–Ω–æ!</button>
                            </div>
                        `;
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –∏ –ø–æ–∫—É–ø–∫–∏
                        await Promise.all([
                            loadBalance(),
                            loadPurchases()
                        ]);
                    }
                } else {
                    throw new Error(data.error || '–û—à–∏–±–∫–∞ –ø–æ–∫—É–ø–∫–∏');
                }
            } catch (error) {
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
                modalContent.innerHTML = originalHTML;
                
                if (tg?.HapticFeedback) {
                    tg.HapticFeedback.notificationOccurred('error');
                }
                
                modalContent.innerHTML = `
                    <div style="text-align: center; padding: 30px;">
                        <div style="font-size: 64px; margin-bottom: 20px;">‚ùå</div>
                        <h2>–û—à–∏–±–∫–∞ –ø–æ–∫—É–ø–∫–∏</h2>
                        <p style="margin: 15px 0; color: #ff6b6b;">${error.message}</p>
                        <button class="modal-button cancel" onclick="closeModal()" style="margin-top: 20px; width: 100%;">–ó–∞–∫—Ä—ã—Ç—å</button>
                    </div>
                `;
            }
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–∞–±–æ–≤
        function setupTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentCategory = tab.dataset.category;
                    renderItems();

                    if (tg?.HapticFeedback) {
                        tg.HapticFeedback.impactOccurred('light');
                    }
                });
            });
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
        function showError(message) {
            document.getElementById('shopContent').innerHTML = `
                <div class="error">${message}</div>
            `;
        }

        // –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        init();
    </script>
</body>
</html>
